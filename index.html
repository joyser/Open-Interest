<!doctype html>
<html>
	<head>
    	    <style>
        td.red {
          color: red;
        }
        
        td.green {
          color: green;
        }
        </style>

		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		<!-- development version, includes helpful console warnings -->
    		<script src="Chart.js"></script>
        <script>
            
    		
$( document ).ready(function() {
    
    
    pause = 2;
    pingCounter = 0;
    lookBack = 60
    
    
    
    // set timeout
    var tid = setTimeout(mycode, pause*1000);
    openInterests = [];
    
    let searchParams = new URLSearchParams(window.location.search)
    let pair = searchParams.get('pair')
    
    var cors_api_url = 'https://cors-anywhere.herokuapp.com/';
      function doCORSRequest(options, printResult) {
        var x = new XMLHttpRequest();
        x.open(options.method, cors_api_url + options.url);
        x.onload = x.onerror = function() {
          printResult(x.responseText);
        };
        if (/^POST/i.test(options.method)) {
          x.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        }
        x.send(options.data);
      }
  
  
    function mycode() {
        
        pingCounter++;
        
        doCORSRequest({
            method: 'GET',
            url: "https://www.okex.com/api/futures/v3/instruments/"+pair+"/open_interest",
            data: ""
            }, function printResult(result) {
                
                jsonResult = jQuery.parseJSON(result);
                jsonResult['ping'] = pingCounter;
                
                openInterests.unshift(jsonResult);
                
                
            		//Add chart data
            		myChart.data.datasets[0].data.push(jsonResult['amount']);
            		myChart.data.labels.push(pingCounter);
            		
            		if(openInterests.length > lookBack){
                    
                    openInterests.pop()
                    myChart.data.datasets[0].data.shift();
                    myChart.data.labels.shift();
                    
                }
                
                                
                //console.log(openInterests)
                printData();
                tid = setTimeout(mycode, pause*1000); // repeat myself
        });
        
    }
    
    
    function abortTimer() { // to be called when you want to stop the timer
        clearTimeout(tid);
    }
    
    function printData(){
        
        tableString=""
        
        for (i = 0; i < 30; i++) {
            
            if(openInterests.length > i + 1){
                
                tableString += "<tr><td>"+openInterests[i]['timestamp']+"</td><td>"+openInterests[i]['amount']+"</td>";
                tableString += "<td style='text-align: right'>"+openInterests[i]['ping']+"</td>"
                tableString += "<td style='text-align: right'>"+(openInterests[i]['amount']-openInterests[i+1]['amount'])+"</td></tr>"
            }    
        }
        
        //Want to loop through recent open interest, print last 10 seconds
        $('#recentInterest').html(tableString);
        
        //Update chart 
        myChart.update();
        
    }
    
    //Chart stuff
    var ctx = $('#myChart');
    
    var myChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [], //x-axis
            datasets: [{
                data: [],
                label: pair,
                lineTension: 0,
                borderColor: 'rgba(0,102,204,1)',
                backgroundColor: 'rgba(255,204,153,0.2)'
            }]
        },
        options: {
            scales: {
                yAxes: [{
                    ticks: {
                    }
                }]
            },
            title: {
                display: true,
                text: 'Open Interest'
            }
        }
    });
    

});

    		
    		
    		
    		
		</script>
	</head>
	
	<body>
		<canvas id="myChart" width="400" height="100"></canvas>
		
		<table id="recentInterest" border="1"></table>
		
	</body>
	
</html>